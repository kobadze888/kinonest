// scripts/backup-pro.js
import 'dotenv/config';
import { exec } from 'child_process';
import path from 'path';
import fs from 'fs';

if (!process.env.DATABASE_URL) {
    console.error("РЮї DATABASE_URL рЃљрЃа рЃљрЃарЃўрЃА рЃЏрЃўрЃЌрЃўрЃЌрЃћрЃЉрЃБрЃџрЃў .env рЃцрЃљрЃўрЃџрЃерЃў");
    process.exit(1);
}

// рЃАрЃљрЃЦрЃљрЃдрЃљрЃџрЃЊрЃўрЃА рЃерЃћрЃЦрЃЏрЃюрЃљ
const BACKUP_DIR = path.join(process.cwd(), 'backups');
if (!fs.existsSync(BACKUP_DIR)) {
    fs.mkdirSync(BACKUP_DIR);
}

// рЃцрЃљрЃўрЃџрЃўрЃА рЃАрЃљрЃ«рЃћрЃџрЃў рЃЌрЃљрЃарЃўрЃдрЃўрЃЌ (рЃЏрЃљрЃњ: backup_2025-02-20.sql)
const dateStr = new Date().toISOString().split('T')[0];
const fileName = `backup_${dateStr}.sql`;
const filePath = path.join(BACKUP_DIR, fileName);

console.log("­Ъџђ рЃўрЃгрЃДрЃћрЃЉрЃљ SQL Dump (рЃАрЃарЃБрЃџрЃў рЃЉрЃљрЃќрЃўрЃА рЃњрЃљрЃЊрЃЏрЃЮрЃгрЃћрЃарЃљ)...");

// рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃўрЃА рЃЏрЃЮрЃЏрЃќрЃљрЃЊрЃћрЃЉрЃљ
// --clean: рЃљрЃЏрЃљрЃбрЃћрЃЉрЃА рЃЉрЃарЃФрЃљрЃюрЃћрЃЉрЃћрЃЉрЃА, рЃарЃЮрЃЏ рЃгрЃљрЃерЃљрЃџрЃЮрЃА рЃФрЃЋрЃћрЃџрЃў рЃфрЃ«рЃарЃўрЃџрЃћрЃЉрЃў рЃљрЃдрЃЊрЃњрЃћрЃюрЃўрЃАрЃљрЃА (рЃАрЃБрЃцрЃЌрЃљ рЃцрЃБрЃарЃфрЃџрЃўрЃЊрЃљрЃю рЃарЃЮрЃЏ рЃЊрЃљрЃўрЃгрЃДрЃЮрЃА)
// --no-owner --no-acl: рЃљрЃерЃЮрЃарЃћрЃЉрЃА рЃЎрЃЮрЃюрЃЎрЃарЃћрЃбрЃБрЃџ рЃЏрЃЮрЃЏрЃ«рЃЏрЃљрЃарЃћрЃЉрЃћрЃџрЃќрЃћ рЃЏрЃўрЃЉрЃЏрЃБрЃџ рЃБрЃцрЃџрЃћрЃЉрЃћрЃЉрЃА (рЃћрЃА рЃљрЃБрЃфрЃўрЃџрЃћрЃЉрЃћрЃџрЃўрЃљ рЃАрЃ«рЃЋрЃљ рЃАрЃћрЃарЃЋрЃўрЃАрЃќрЃћ рЃњрЃљрЃЊрЃљрЃАрЃљрЃбрЃљрЃюрЃљрЃЊ)
const command = `pg_dump "${process.env.DATABASE_URL}" --clean --if-exists --no-owner --no-acl -f "${filePath}"`;

exec(command, (error, stdout, stderr) => {
    if (error) {
        console.error(`РЮї рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљ рЃЉрЃћрЃЦрЃљрЃцрЃўрЃА рЃЊрЃарЃЮрЃА: ${error.message}`);
        return;
    }
    if (stderr) {
        // pg_dump рЃќрЃЮрЃњрЃ»рЃћрЃа рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљрЃА stderr-рЃерЃў рЃгрЃћрЃарЃА, рЃћрЃА рЃАрЃБрЃџрЃљрЃф рЃљрЃа рЃюрЃўрЃерЃюрЃљрЃЋрЃА рЃерЃћрЃфрЃЊрЃЮрЃЏрЃљрЃА
        console.log(`Рё╣№ИЈ рЃўрЃюрЃцрЃЮрЃарЃЏрЃљрЃфрЃўрЃљ: ${stderr}`);
    }
    console.log(`\nРюЁ рЃЉрЃћрЃЦрЃљрЃцрЃў рЃгрЃљрЃарЃЏрЃљрЃбрЃћрЃЉрЃўрЃЌ рЃерЃћрЃўрЃЦрЃЏрЃюрЃљ!`);
    console.log(`­ЪЊѓ рЃцрЃљрЃўрЃџрЃў: ${filePath}`);
    console.log(`­ЪњА рЃљрЃЏ рЃцрЃљрЃўрЃџрЃўрЃЌ рЃерЃћрЃњрЃўрЃФрЃџрЃўрЃљрЃЌ рЃљрЃдрЃљрЃЊрЃњрЃўрЃюрЃЮрЃЌ рЃЉрЃљрЃќрЃљ рЃюрЃћрЃЉрЃўрЃАрЃЏрЃўрЃћрЃа рЃАрЃћрЃарЃЋрЃћрЃарЃќрЃћ.`);
});